<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>স্টাডি ট্র্যাকার | পড়াশোনার অগ্রগতি ট্র্যাক করুন</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- SweetAlert2 script -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Basic Light Theme Variables */
        :root {
            --bg-body: linear-gradient(135deg, #4f46e5 0%, #1e3a8a 100%);
            --bg-overlay: rgba(0, 0, 0, 0.45);
            --bg-card: rgba(255, 255, 255, 0.85);
            --bg-aside: rgba(255, 255, 255, 0.8);
            --text-primary: #1f2937; /* Gray 800 */
            --text-secondary: #4b5563; /* Gray 600 */
            --text-light: #f9fafb; /* Gray 50 */
            --text-accent: #2563eb; /* Blue 600 */
            --border-color: rgba(255, 255, 255, 0.25);
            --input-border: #D1D5DB; /* Gray 300 */
            --input-bg: #ffffff;
            --shadow-card: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            --badge-bg: #e0e7ff; /* Indigo 100 */
            --badge-text: #3730a3; /* Indigo 800 */
            --history-item-bg: rgba(249, 250, 251, 0.8); /* bg-gray-50/80 */
            --history-item-border: #e5e7eb; /* border-gray-200 */
            /* Chart colors */
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-tick-color: #6b7280; /* Gray 500 */
            --chart-bar-color: #3b82f6; /* Blue 500 */
            --chart-bar-hover-color: #2563eb; /* Blue 600 */
            /* Button specific */
            --btn-gemini-bg: linear-gradient(to right, #4285F4, #9b72cb, #d96570, #f2a600);
            --btn-gemini-text: white;
            --btn-gemini-hover-opacity: 0.9;
            --btn-gemini-disabled-opacity: 0.6;
        }

        /* Dark Theme Variables */
        .dark {
            --bg-body: linear-gradient(135deg, #1f2937 0%, #111827 100%); /* Darker Gradient */
            --bg-overlay: rgba(0, 0, 0, 0.6); /* Darker Overlay */
            --bg-card: rgba(31, 41, 55, 0.8); /* Gray 800 semi-transparent */
            --bg-aside: rgba(17, 24, 39, 0.85); /* Gray 900 semi-transparent */
            --text-primary: #f9fafb; /* Gray 50 */
            --text-secondary: #d1d5db; /* Gray 300 */
            --text-light: #f9fafb; /* Gray 50 */
            --text-accent: #60a5fa; /* Blue 400 */
            --border-color: rgba(255, 255, 255, 0.1);
            --input-border: #4b5563; /* Gray 600 */
            --input-bg: #374151; /* Gray 700 */
            --shadow-card: 0 10px 25px -5px rgba(0,0,0,0.4), 0 10px 10px -5px rgba(0,0,0,0.3);
            --badge-bg: #312e81; /* Indigo 900 */
            --badge-text: #c7d2fe; /* Indigo 200 */
            --history-item-bg: rgba(55, 65, 81, 0.8); /* dark:bg-gray-600/80 */
            --history-item-border: #4b5563; /* dark:border-gray-500 */
             /* Chart colors */
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --chart-tick-color: #9ca3af; /* Gray 400 */
            --chart-bar-color: #60a5fa; /* Blue 400 */
            --chart-bar-hover-color: #3b82f6; /* Blue 500 */
        }

        body {
            font-family: 'Hind Siliguri', sans-serif;
            background: var(--bg-body);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            transition: background 1s ease-in-out, color 0.3s ease;
            color: var(--text-primary);
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-overlay);
            z-index: -1;
            transition: background-color 0.3s ease;
        }
        .main-container { min-height: 100vh; display: flex; flex-direction: column; }
        .nav-item { transition: all 0.3s ease; color: var(--text-secondary); }
        .nav-item:hover { background-color: rgba(96, 165, 250, 0.2); } /* Blue hover subtle */
        .nav-item.active { background-color: var(--text-accent); color: white; }
        .dark .nav-item.active { background-color: var(--text-accent); color: var(--bg-aside); }

        .card {
            background-color: var(--bg-card);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-card);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        aside {
            background-color: var(--bg-aside);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        /* Update other elements for dark mode */
        input, textarea, select {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        input::placeholder, textarea::placeholder {
             color: var(--text-secondary);
        }
        /* Specific Text Colors */
        .text-main-primary { color: var(--text-primary); }
        .text-main-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--text-accent); }

        .text-white\/90 { color: rgba(249, 250, 251, 0.9); } /* Gray 50 */
        .dark .text-white\/90 { color: rgba(249, 250, 251, 0.9); }
        .text-white\/80 { color: rgba(249, 250, 251, 0.8); }
        .dark .text-white\/80 { color: rgba(209, 213, 219, 0.8); } /* Gray 300 */
        .bg-blue-50\/70 { background-color: rgba(239, 246, 255, 0.7); }
        .dark .bg-blue-50\/70 { background-color: rgba(55, 65, 81, 0.7); } /* Gray 600 */
        .text-blue-800 { color: #1e40af; }
        .dark .text-blue-800 { color: #93c5fd; } /* Blue 300 */
        .text-blue-900 { color: #1e3a8a; }
        .dark .text-blue-900 { color: #bfdbfe; } /* Blue 200 */
        .bg-gray-100 { background-color: #f3f4f6; }
        .dark .bg-gray-100 { background-color: #4b5563; } /* Gray 600 */

        /* History Item specific styles - Using CSS Variables */
        .history-item {
            background-color: var(--history-item-bg);
            border: 1px solid var(--history-item-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .history-item-subject {
            color: var(--text-primary);
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .history-item-topic {
            font-weight: 400;
             color: var(--text-primary);
             transition: color 0.3s ease;
        }
        .history-item-time {
            color: var(--text-secondary);
             transition: color 0.3s ease;
        }


        .btn-primary { background-color: var(--text-accent); color: white; transition: background-color 0.3s ease; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background-color: #ef4444; color: white; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #dc2626; }
        .btn-google {
            background-color: #ffffff;
            color: #374151;
            border: 1px solid #D1D5DB;
            transition: background-color 0.3s ease;
        }
        .btn-google:hover { background-color: #f9fafb; }
        .dark .btn-google { background-color: #374151; color: #f9fafb; border-color: #4b5563; }
        .dark .btn-google:hover { background-color: #4b5563; }

        /* Gemini Button Style */
        .btn-gemini {
            background: var(--btn-gemini-bg);
            color: var(--btn-gemini-text);
            transition: opacity 0.3s ease;
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
        }
        .btn-gemini:hover {
             opacity: var(--btn-gemini-hover-opacity);
        }
         .btn-gemini:disabled {
             opacity: var(--btn-gemini-disabled-opacity);
             cursor: not-allowed;
         }


        .progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 20px; }
        .dark .progress-bar-container { background-color: #4b5563; }
        .progress-bar { background-color: #34d399; transition: width 0.5s ease-in-out; }

        /* Theme Toggle Button */
        #theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 2.5rem; /* Fixed width */
            height: 2.5rem; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-card);
            font-size: 1.25rem; /* Adjust emoji size */
        }

        /* Subject Summary */
        .subject-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--input-border);
        }
         .subject-summary-item:last-child {
            border-bottom: none;
         }

         /* Mobile Nav Icons Emoji Size */
         #mobile-nav span.emoji-icon {
             font-size: 1.5rem; /* Larger emoji size */
             line-height: 1;
             margin-bottom: 0.125rem; /* Adjust spacing */
         }

         /* Badge Styles */
         .badge {
             display: inline-flex;
             align-items: center;
             padding: 0.25rem 0.75rem;
             border-radius: 9999px;
             font-size: 0.8rem;
             font-weight: 500;
             background-color: var(--badge-bg);
             color: var(--badge-text);
             /* margin-right: 0.5rem; */ /* Replaced by gap on parent */
             /* margin-bottom: 0.5rem; */ /* Replaced by gap on parent */
         }
         .badge span:first-child { /* Emoji */
              margin-right: 0.3rem;
              font-size: 1rem;
         }
         /* Weekly Chart Canvas Height */
         #weeklyChartCanvas {
             max-height: 300px; /* Adjust height as needed */
         }
         /* Today Pie Chart Canvas Height */
         #todayPieChartCanvas {
             max-height: 260px; /* Adjust height as needed, slightly less to fit legend */
         }

         /* SweetAlert Custom Styles */
         .swal2-html-container {
             text-align: left !important;
             margin-left: 1em !important;
             margin-right: 1em !important;
         }
         .swal2-html-container br {
             content: "";
             margin: 0.5em 0;
             display: block;
         }
         .dark .swal2-popup {
             background-color: #1f2937 !important; /* bg-gray-800 */
             color: #f9fafb !important; /* text-gray-50 */
         }
         .dark .swal2-title {
             color: #f9fafb !important;
         }
         .dark .swal2-html-container {
             color: #d1d5db !important; /* text-gray-300 */
         }
         .dark .swal2-confirm {
             background-color: #60a5fa !important; /* bg-blue-400 */
         }
         .dark .swal2-cancel {
             background-color: #9ca3af !important; /* bg-gray-400 */
         }

         /* About Me Background Element Style */
         .bg-element {
             position: absolute;
             color: var(--text-secondary);
             opacity: 0.15; /* Slightly more visible */
             font-family: sans-serif; /* Use sans-serif for shapes */
             user-select: none; /* Prevent selection */
             pointer-events: none; /* Prevent interaction */
             z-index: 5; /* Below main content */
         }
         .dark .bg-element {
             opacity: 0.1; /* Slightly less visible in dark mode */
         }

    </style>
</head>
<body>
    <!-- Theme Toggle Button with Emojis -->
    <button id="theme-toggle" title="Toggle theme">
        <span id="theme-icon-light">☀️</span>
        <span id="theme-icon-dark" class="hidden">🌙</span>
    </button>

    <div class="main-container">
        <!-- Main Content -->
        <div class="flex flex-1">
            <!-- Sidebar Navigation (Initially Hidden on small screens, shown on medium+) -->
            <aside class="w-64 shadow-lg p-4 flex-shrink-0 hidden md:flex flex-col">
                <div class="text-2xl font-bold text-blue-600 mb-8 text-center">স্টাডি ট্র্যাকার 📖⌚</div>
                <nav id="sidebar-nav" class="flex flex-col space-y-2 flex-grow">
                    <a href="#" id="nav-dashboard" class="nav-item py-2 px-4 rounded-lg font-semibold hover:bg-blue-100">ড্যাশবোর্ড</a>
                    <a href="#" id="nav-profile" class="nav-item py-2 px-4 rounded-lg font-semibold hover:bg-blue-100">প্রোফাইল</a>
                    <a href="#" id="nav-about" class="nav-item py-2 px-4 rounded-lg font-semibold hover:bg-blue-100">আমার সম্পর্কে</a>
                </nav>
                <button id="logout-button" class="w-full btn-secondary font-bold py-2 px-4 rounded-lg mt-4 hidden">লগ আউট</button>
            </aside>

            <main class="flex-1 p-4 md:p-8 overflow-y-auto pb-20 md:pb-8">
                <!-- Login View (Initially Shown) -->
                <div id="login-view">
                     <div class="flex items-center justify-center min-h-[80vh]">
                         <div class="text-center card max-w-md mx-auto">
                             <h1 class="text-3xl font-bold mb-2">স্বাগতম!</h1>
                             <p class="text-main-secondary mb-8">লগইন করুন অথবা নতুন অ্যাকাউন্ট তৈরি করুন।</p>

                             <!-- Google Sign-in Button -->
                             <button id="google-login-button" class="w-full btn-google font-bold py-3 px-4 rounded-lg mb-4 flex items-center justify-center space-x-2">
                                 <svg class="w-5 h-5" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.567-3.108-11.283-7.481l-6.571 4.819C9.656 39.663 16.318 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-0.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C39.999 36.31 44 30.603 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                                 <span>Google দিয়ে চালিয়ে যান</span>
                             </button>

                             <div class="my-4 flex items-center justify-center">
                                 <span class="flex-grow bg-gray-300 h-px"></span>
                                 <span class="mx-4 text-sm text-main-secondary">অথবা</span>
                                 <span class="flex-grow bg-gray-300 h-px"></span>
                             </div>

                             <input type="email" id="login-email" placeholder="student.email@example.com" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="email">
                             <input type="password" id="login-password" placeholder="পাসওয়ার্ড" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="current-password">
                             <button id="login-button" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mb-4">প্রবেশ করুন / অ্যাকাউন্ট তৈরি করুন</button>
                             <a href="#" id="forgot-password-link" class="text-sm text-accent hover:underline">পাসওয়ার্ড ভুলে গেছেন?</a>
                         </div>
                     </div>
                </div>

                <!-- Dashboard View (Initially Hidden) -->
                <div id="dashboard-view" class="hidden">
                    <h1 class="text-3xl font-bold text-white/90 drop-shadow-lg mb-6">ড্যাশবোর্ড</h1>

                    <!-- Motivational Quote -->
                    <div id="quote-container" class="mb-6 p-4 bg-blue-50/70 border-l-4 border-blue-500 rounded-r-lg">
                        <p id="quote-text" class="text-blue-800 italic">"Loading quote..."</p>
                        <p id="quote-author" class="text-blue-900 font-semibold mt-2 text-xs text-right"></p>
                    </div>

                    <!-- Timer and Goal Section -->
                    <div class="card mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <!-- Left: Timer Controls -->
                            <div>
                                <h2 class="text-2xl font-bold mb-4">আজকের সেশন</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label for="daily-goal" class="block text-sm font-medium text-main-secondary">আজকের লক্ষ্য (ঘন্টা)</label>
                                        <input type="number" id="daily-goal" value="7" min="1" max="24" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="subject" class="block text-sm font-medium text-main-secondary">বিষয়</label>
                                        <input type="text" id="subject" placeholder="যেমন: গণিত" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div>
                                        <label for="topic" class="block text-sm font-medium text-main-secondary">টপিক</label>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <input type="text" id="topic" placeholder="যেমন: ত্রিকোণমিতি" class="block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                            <button id="get-topic-details-btn" title="Get Topic Details" class="btn-gemini flex-shrink-0">✨</button>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4">
                                        <button id="start-btn" class="w-full btn-primary font-bold py-3 rounded-lg text-lg">পড়া শুরু করুন</button>
                                        <button id="stop-btn" class="w-full btn-secondary font-bold py-3 rounded-lg text-lg hidden">থামুন এবং সংরক্ষণ করুন</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Summary -->
                            <div class="text-center bg-blue-50/70 p-6 rounded-lg">
                                 <p class="text-lg font-semibold text-blue-800">টাইমার</p>
                                <div id="timer" class="text-6xl font-bold text-accent my-4">00:00:00</div>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-md text-main-secondary">আজ পড়েছেন</p>
                                        <p id="today-total" class="text-2xl font-bold text-main-primary">0 ঘন্টা 0 মিনিট</p>
                                    </div>
                                    <div>
                                        <p class="text-md text-main-secondary">লক্ষ্য বাকি</p>
                                        <p id="today-remaining" class="text-2xl font-bold text-main-primary">7 ঘন্টা 0 মিনিট</p>
                                    </div>
                                    <div class="w-full progress-bar-container mt-4">
                                        <div id="progress-bar" class="progress-bar h-full" style="width: 0%;"></div>
                                    </div>
                                    <!-- Subject Summary Section -->
                                    <div id="subject-summary-today" class="mt-6 text-left">
                                        <h4 class="text-md font-semibold mb-2 text-center border-b pb-1 text-main-secondary">আজকের বিষয়ভিত্তিক সময়</h4>
                                        <div id="subject-summary-list" class="text-sm">
                                             <p class="text-main-secondary text-center py-2">এখনও কোনো সেশন সম্পন্ন হয়নি।</p>
                                        </div>
                                    </div>
                                    <!-- Rank Display Box -->
                                    <div class="mt-6 text-center border-t pt-4 border-[var(--input-border)]">
                                        <h4 class="text-md font-semibold mb-2 text-main-secondary">সাপ্তাহিক র‍্যাঙ্ক</h4>
                                        <div id="rank-display" class="text-4xl mb-2">
                                            <span id="rank-emoji">🥉</span>
                                            <span id="rank-name" class="text-2xl align-middle font-semibold text-main-primary">Bronze</span>
                                        </div>
                                        <div class="text-sm space-y-1">
                                            <p><span class="font-medium text-main-secondary">আজকের পয়েন্ট:</span> <span id="today-points" class="font-bold text-main-primary">0.00</span></p>
                                            <p><span class="font-medium text-main-secondary">এই সপ্তাহের পয়েন্ট:</span> <span id="weekly-points" class="font-bold text-main-primary">0.00</span></p>
                                        </div>
                                    </div>
                                    <!-- END: Rank Display Box -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Summary Chart -->
                     <div class="card mb-8">
                         <h2 class="text-2xl font-bold mb-4">সাপ্তাহিক সারাংশ (ঘন্টা)</h2>
                         <div class="relative">
                             <canvas id="weeklyChartCanvas"></canvas>
                         </div>
                     </div>

                    <!-- History & Pie Chart Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- History Log -->
                        <div class="card">
                            <h2 class="text-2xl font-bold mb-4">আজকের সম্পন্ন টপিক</h2>
                            <div id="history-log" class="space-y-3 max-h-80 overflow-y-auto">
                                <p class="text-main-secondary">এখনও কোনো টপিক সম্পন্ন হয়নি।</p>
                            </div>
                        </div>

                        <!-- Today's Subject Pie Chart -->
                        <div class="card">
                            <h2 class="text-2xl font-bold mb-4">আজকের বিষয়ভিত্তিক সারাংশ</h2>
                            <div class="relative" style="max-height: 300px;"> <!-- Container for canvas -->
                                <canvas id="todayPieChartCanvas"></canvas>
                            </div>
                            <!-- Custom legend or fallback text -->
                            <div id="pie-chart-legend" class="mt-4 text-center text-sm text-main-secondary">
                                <p>আজ কোনো বিষয় পড়া হয়নি।</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile View (Initially Hidden) -->
                <div id="profile-view" class="hidden">
                     <h1 class="text-3xl font-bold text-white/90 drop-shadow-lg mb-6">প্রোফাইল</h1>
                    <div class="card max-w-2xl mx-auto">
                        <div class="flex flex-col items-center space-y-4">
                            <img id="profile-img-display" src="https://placehold.co/128x128/E2E8F0/4A5568?text=ছবি" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-gray-300 dark:border-gray-600">
                            <div id="img-upload-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
                            <input type="file" id="profile-img-upload" class="hidden" accept="image/*">
                            <button onclick="document.getElementById('profile-img-upload').click()" class="text-sm text-accent hover:underline">ছবি পরিবর্তন করুন</button>
                        </div>
                        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="profile-name" class="block text-sm font-medium text-main-secondary">নাম</label>
                                <input type="text" id="profile-name" class="mt-1 block w-full border rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="profile-email" class="block text-sm font-medium text-main-secondary">ইমেইল</label>
                                <input type="email" id="profile-email" class="mt-1 block w-full border rounded-md shadow-sm bg-gray-100" readonly>
                             </div>
                            <div>
                                <label for="profile-mobile" class="block text-sm font-medium text-main-secondary">মোবাইল</label>
                                <input type="text" id="profile-mobile" class="mt-1 block w-full border rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="profile-class" class="block text-sm font-medium text-main-secondary">একাডেমিক ক্লাস</label>
                                <input type="text" id="profile-class" class="mt-1 block w-full border rounded-md shadow-sm">
                            </div>
                             <div class="md:col-span-2">
                                <label for="profile-institution" class="block text-sm font-medium text-main-secondary">শিক্ষা প্রতিষ্ঠান</label>
                                <input type="text" id="profile-institution" class="mt-1 block w-full border rounded-md shadow-sm">
                            </div>
                             <div class="md:col-span-2">
                                <label for="profile-motivation" class="block text-sm font-medium text-main-secondary">আপনার মোটিভেশন</label>
                                <textarea id="profile-motivation" rows="3" class="mt-1 block w-full border rounded-md shadow-sm"></textarea>
                            </div>
                        </div>

                        <!-- Achievement Section -->
                        <div class="mt-8 pt-6 border-t border-[var(--input-border)]">
                            <h3 class="text-lg font-semibold mb-3 text-center">অর্জন</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                                <!-- Weekly Rank -->
                                <div>
                                    <h4 class="text-md font-semibold mb-2 text-main-secondary">বর্তমান সাপ্তাহিক র‍্যাঙ্ক</h4>
                                    <div id="profile-rank-display" class="text-4xl mb-2">
                                        <span id="profile-rank-emoji">🥉</span>
                                        <span id="profile-rank-name" class="text-2xl align-middle font-semibold text-main-primary">Bronze</span>
                                    </div>
                                    <p class="text-sm"><span class="font-medium text-main-secondary">এই সপ্তাহের পয়েন্ট:</span> <span id="profile-weekly-points" class="font-bold text-main-primary">0.00</span></p>
                                </div>
                                <!-- Lifetime Points -->
                                <div>
                                    <h4 class="text-md font-semibold mb-2 text-main-secondary">মোট পড়ার সময় (Lifetime)</h4>
                                    <p><span id="profile-points" class="font-bold text-3xl text-accent">0.00</span> <span class="text-main-secondary">ঘন্টা</span></p>
                                    <p class="text-sm text-main-secondary">(সর্বমোট পয়েন্ট)</p>
                                </div>
                            </div>
                            <!-- Lifetime Badges Section -->
                            <div class="mt-4">
                                <h4 class="font-medium mb-2 text-main-secondary text-center">ব্যাজসমূহ (Lifetime):</h4>
                                <div id="profile-badges" class="flex flex-wrap justify-center gap-2">
                                    <p class="text-main-secondary text-sm">এখনও কোনো ব্যাজ অর্জন করেননি।</p>
                                </div>
                            </div>
                        </div>
                        <!-- End Achievement Section -->

                        <div class="mt-8 text-right">
                             <button id="save-profile" class="btn-primary font-bold py-2 px-6 rounded-lg">সংরক্ষণ করুন</button>
                        </div>
                    </div>
                </div>
                
                <!-- *** MODIFIED: About Me View *** -->
                <div id="about-view" class="hidden">
                     <h1 class="text-3xl font-bold text-white/90 drop-shadow-lg mb-6">আমার সম্পর্কে</h1>
                     <!-- Card with background elements -->
                    <div class="card max-w-3xl mx-auto relative overflow-hidden">
                        
                        <!-- Background Elements (Slightly more visible) -->
                        <div class="bg-element font-mono text-2xl" style="top: 10%; left: 10%; transform: rotate(-15deg);" aria-hidden="true">E = mc²</div>
                        <div class="bg-element font-mono text-lg" style="top: 25%; right: 12%; transform: rotate(15deg);" aria-hidden="true">P(A|B) = P(B|A)P(A)/P(B)</div>
                        <div class="bg-element font-mono text-3xl" style="bottom: 18%; left: 20%; transform: rotate(8deg);" aria-hidden="true">∫ f(x)dx</div>
                        <div class="bg-element font-mono text-2xl" style="bottom: 12%; right: 25%; transform: rotate(-6deg);" aria-hidden="true">σ² = Σ(x-μ)²/N</div>
                        <div class="bg-element font-mono text-xl" style="top: 70%; left: 12%; transform: rotate(5deg);" aria-hidden="true">F = ma</div>
                        <div class="bg-element font-mono text-2xl" style="top: 50%; right: 30%; transform: rotate(-10deg);" aria-hidden="true">x̄ = Σx/n</div>
                        
                        <!-- Geometric Shapes -->
                        <div class="bg-element text-4xl" style="top: 15%; right: 20%; transform: rotate(25deg);" aria-hidden="true">△</div>
                        <div class="bg-element text-3xl" style="bottom: 30%; left: 10%; transform: rotate(-20deg);" aria-hidden="true">□</div>
                        <div class="bg-element text-2xl" style="top: 80%; right: 15%; transform: rotate(10deg);" aria-hidden="true">∑</div>
                        <div class="bg-element text-3xl" style="top: 40%; left: 15%; transform: rotate(30deg);" aria-hidden="true">π</div>
                         <div class="bg-element text-4xl" style="bottom: 45%; right: 10%; transform: rotate(-25deg);" aria-hidden="true">∇</div>


                        <!-- Main Content -->
                        <div class="relative z-10 grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                            <!-- Image -->
                            <div class="md:col-span-1 flex justify-center">
                                <!-- *** MODIFIED: Corrected image path (removed 'images/' folder) *** -->
                                <img src="IMG_20240916_161328.png" alt="সাদ" class="w-40 h-40 rounded-full object-cover border-4 border-[var(--input-border)] shadow-lg" onerror="this.src='https://placehold.co/160x160/E2E8F0/4A5568?text=Saad';">
                            </div>

                            <!-- Text -->
                            <div class="md:col-span-2 space-y-3">
                                <p class="text-lg">আসসালামু আলাইকুম!😃</p>
                                <p class="text-main-primary">আমি <strong>সাদ</strong> — রাজশাহী বিশ্ববিদ্যালয়ের <strong> পরিসংখ্যান বিভাগের ৬৩তম ব্যাচের </strong> একজন শিক্ষার্থী 🎓। সংখ্যার জগৎ আমার খুব প্রিয়, আর সেই ভালোবাসা থেকেই আমি এই পথে হাঁটছি।🥱</p>
                                <p class="text-main-primary">এই প্রজেক্টটা আমার কাছে অনেক বিশেষ ❤️</p>
                                <p class="text-main-primary">কারণ আমি নিজেই একজন “ফাঁকিবাজ” ছাত্র 😅 — সময়মতো পড়াশোনা করা বা সময়কে কাজে লাগানো আমার পক্ষে সবসময় সহজ ছিল না। তাই এই Study Tracker ওয়েবসাইটটা তৈরি করেছি যেন নিজেকে একটু মোটিভেট রাখতে পারি, আর পড়াশোনার সময়গুলো ঠিকভাবে ট্র্যাক করতে পারি ⏱️</p>
                                <p class="text-main-primary">আমি চাই, পড়াশোনাতেও যেন ঠিক গেমের মতোই প্রতি সপ্তাহে <strong>“Heroic Rank”</strong> অর্জন করতে পারি 🏆 — কারণ গেমে তো আমি সবসময়ই হিরোইক র‍্যাঙ্ক হোল্ডার 😉</p>
                                <p class="text-main-primary">আর হ্যাঁ, একটা কথাই বলি —</p>
                                <p class="text-2xl font-bold text-accent italic text-center my-4">✨ “Life is easy, when you take it easy!” ✨</p>
                                <p class="text-lg font-semibold text-right">— TaTa 👋</p>
                            </div>
                        </div>

                        <!-- "Join Me" / Social Links Section -->
                        <div class="relative z-10 mt-8 pt-6 border-t border-[var(--input-border)]">
                            <h3 class="text-xl font-bold text-center mb-6 text-main-primary">যোগাযোগ করুন</h3>
                            <div class="flex flex-wrap justify-center gap-4">
                                <!-- LinkedIn -->
                                <a href="https://www.linkedin.com/in/shafin-sanyan-saad/" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 px-5 py-2 rounded-lg bg-[#0077B5] text-white font-semibold transition hover:opacity-90 shadow-md">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                                    <span>LinkedIn</span>
                                </a>
                                <!-- Facebook -->
                                <a href="https://www.facebook.com/shafin.sanyan.saad" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 px-5 py-2 rounded-lg bg-[#1877F2] text-white font-semibold transition hover:opacity-90 shadow-md">
                                     <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385h-3.038v-3.47h3.038v-2.661c0-3.004 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953h-1.513c-1.49 0-1.956.925-1.956 1.874v2.267h3.328l-.532 3.47h-2.796v8.385c5.737-.9 10.125-5.864 10.125-11.854z"/></svg>
                                    <span>Facebook</span>
                                </a>
                                <!-- WhatsApp -->
                                <!-- Assumed +880 country code for Bangladesh -->
                                <a href="https://wa.me/8801776650834" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 px-5 py-2 rounded-lg bg-[#25D366] text-white font-semibold transition hover:opacity-90 shadow-md">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.04 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm.001 2.16c5.42 0 9.841 4.42 9.841 9.841 0 5.42-4.42 9.841-9.841 9.841-1.601 0-3.11-.38-4.441-1.051l-5.051 1.351 1.371-4.921c-.741-1.381-1.151-2.951-1.151-4.621 0-5.42 4.42-9.841 9.841-9.841zm-2.351 5.4c-.211-.111-.471-.181-.731-.201-.3-.02-.62.03-.9.131-.32.111-.6.281-.82.521-.23.23-.42.521-.52.841-.11.311-.13.631-.08.961.05.33.18.631.36.9.18.27.42.51.72.72s.63.42.99.57c.36.15.75.27 1.17.36s.87.12 1.32.09c.45-.03.88-.13 1.28-.291.4-.16.76-.39 1.06-.671.3-.28.51-.6.64-.951.13-.35.18-.72.18-1.1v-.01c0-.18-.01-.36-.03-.531-.02-.17-.05-.34-.1-.491-.05-.15-.11-.3-.18-.441-.07-.14-.15-.28-.25-.41-.1-.13-.21-.25-.33-.36s-.26-.2-.41-.28c-.15-.08-.31-.15-.48-.2s-.35-.09-.53-.12c-.18-.03-.36-.05-.55-.05-.19 0-.38.02-.56.061-.18.04-.36.1-.52.171-.16.07-.31.15-.45.241-.14.09-.27.2-.39.311s-.22.23-.31.36c-.09.13-.17.27-.22.41s-.1.29-.12.441c-.02.15-.03.3-.03.46 0 .15.01.3.04.44s.07.27.13.39c.06.12.13.23.22.33s.19.18.3.25c.11.07.23.13.36.17.13.04.26.07.4.08.14.01.28.01.42 0 .14 0 .28-.02.41-.05.13-.03.26-.07.38-.13.12-.06.23-.13.33-.21.1-.08.19-.18.27-.28s.15-.22.2-.34c.05-.12.08-.25.1-.38.02-.13.02-.26.02-.4 0-.21-.03-.42-.08-.62-.05-.2-.13-.39-.23-.56s-.23-.33-.37-.46c-.14-.13-.3-.24-.47-.33s-.35-.16-.54-.22c-.19-.06-.38-.1-.58-.12z"/></svg>
                                    <span>WhatsApp</span>
                                </a>
                            </div>
                        </div>

                    </div>
                </div>
                <!-- *** END: About Me View *** -->


                <footer class="text-center pt-8 text-white/80 font-semibold text-xs drop-shadow-md">
                    Created by Saad | STAT - 63 | RU
                </footer>

            </main>
        </div>

        <!-- Mobile Bottom Navigation (Initially Hidden) -->
        <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg shadow-t-lg justify-around p-2 hidden">
            <a href="#" id="mobile-nav-dashboard" class="text-center text-blue-600 dark:text-blue-400 p-2">
                <span class="emoji-icon mx-auto">📊</span>
                <span class="text-xs">ড্যাশবোর্ড</span>
            </a>
            <a href="#" id="mobile-nav-profile" class="text-center text-gray-500 dark:text-gray-400 p-2">
                 <span class="emoji-icon mx-auto">👤</span>
                <span class="text-xs">প্রোফাইল</span>
            </a>
            <a href="#" id="mobile-nav-about" class="text-center text-gray-500 dark:text-gray-400 p-2">
                 <span class="emoji-icon mx-auto">👨‍💻</span>
                <span class="text-xs">আমার সম্পর্কে</span>
            </a>
            <a href="#" id="mobile-logout-button" class="text-center text-gray-500 dark:text-gray-400 p-2">
                 <span class="emoji-icon mx-auto">🚪</span>
                <span class="text-xs">লগ আউট</span>
            </a>
        </nav>

    </div>

<!--
    **************************************************
    * FIREBASE & GEMINI SCRIPT START                 *
    **************************************************
-->

<script type="module">
    // --- FIREBASE SDK IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        sendPasswordResetEmail,
        signOut
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        updateDoc,
        onSnapshot,
        arrayUnion,
        increment
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";


    // --- !! IMPORTANT !! ---
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyASoBtoZ3tb7_9joLCaL9jFA3uW-QlCvnA", // *** WARNING: Consider using environment variables for API keys in production ***
        authDomain: "study-trucker-dc956.firebaseapp.com",
        projectId: "study-trucker-dc956",
        storageBucket: "study-trucker-dc956.appspot.com",
        messagingSenderId: "457109620815",
        appId: "1:457109620815:web:a71f94e25585cef3d3823a",
        measurementId: "G-T8JNPYCPXB"
    };
    // --- !! END OF CONFIG !! ---

    // --- FIREBASE INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // --- STATE MANAGEMENT ---
    let currentUser = null;
    let state = null;
    let userDocRef = null;
    let firestoreUnsubscribe = null;
    let initialLoadComplete = false;
    let timerInterval = null;
    let quoteInterval = null;
    let weeklyChartInstance = null;
    let todayPieChartInstance = null;
    let previousRankName = null;
    const weeklyChartCanvas = document.getElementById('weeklyChartCanvas');

    // --- BADGE DEFINITIONS ---
    const badges = {
        'first_hour':   { name: 'প্রথম ১ ঘন্টা', emoji: '🏆', threshold: 1, type: 'points' },
        'ten_hours':    { name: '১০ ঘন্টা সম্পন্ন', emoji: '⏱️', threshold: 10, type: 'points' },
        'fifty_hours':  { name: '৫০ ঘন্টা সম্পন্ন', emoji: '⏳', threshold: 50, type: 'points' },
        'hundred_hours': { name: '১০০ ঘন্টা', emoji: '💯', threshold: 100, type: 'points' },
        'five_hundred_hours': { name: '৫০০ ঘন্টা', emoji: '🔥', threshold: 500, type: 'points' },
        'thousand_hours': { name: '১০০০+ ঘন্টা', emoji: '⭐', threshold: 1000, type: 'points' },
        'goal_achiever': { name: 'লক্ষ্য পূরণকারী', emoji: '🎯', type: 'goal_met' },
    };

    // --- RANK DEFINITIONS ---
    const ranks = [
        { name: 'Bronze', emoji: '🥉', minHours: 0 },
        { name: 'Silver', emoji: '🥈', minHours: 20 },
        { name: 'Gold', emoji: '🥇', minHours: 40 },
        { name: 'Platinum', emoji: '💠', minHours: 60 },
        { name: 'Diamond', emoji: '💎', minHours: 80 },
        { name: 'Heroic', emoji: '🦸', minHours: 100 },
    ];

    // --- Fallback Quotes ---
    const fallbackQuotes = [
            { text: "পড়ুন আপনার পালনকর্তার নামে যিনি সৃষ্টি করেছেন।", author: "আল-কুরআন, সূরা আলাক : ১" },
            { text: "এবং বলুন, হে আমার পালনকর্তা, আমার জ্ঞান বৃদ্ধি করুন।", author: "আল-কুরআন, সূরা ত্বা-হা : ১১৪" },
            { text: "যে ব্যক্তি জ্ঞানের সন্ধানে বের হয়, সে আল্লাহর পথে থাকে যতক্ষণ না সে ফিরে আসে।", author: "তিরমিযী - ২৬৪৭" },
            { text: "...যাদের জ্ঞান দান করা হয়েছে, আল্লাহ তাদেরকে বহু স্তরে উন্নত করবেন।", author: "আল-কুরআন, সূরা মুজাদালা : ১১" },
            { text: "যিনি জ্ঞান অনুসন্ধান করেন, আল্লাহ তার জান্নাতের পথ সহজ করে দেন।", author: "সহীহ মুসলিম - ২৬৯৯" },
            { text: "সফলতা হলো প্রস্তুতির সাথে সুযোগের মিলন।", author: "ববি আনসার" },
            { text: "জ্ঞানই শক্তি।", author: "ফ্রান্সিস বেকন" },
            { text: "আপনার ভবিষ্যতের ভবিষ্যদ্বাণী করার সেরা উপায় হল এটি তৈরি করা।", author: "আব্রাহাম লিংকন" },
            { text: "শিক্ষা সবচেয়ে শক্তিশালী অস্ত্র যা আপনি বিশ্বকে পরিবর্তন করতে ব্যবহার করতে পারেন।", author: "নেলসন ম্যান্ডেলা" },
            { text: "চেষ্টা করার আগে হাল ছেড়ো না।", author: "সংগৃহীত" },
            { text: "ব্যর্থতা মানেই সব শেষ নয়, এটি নতুন করে শুরু করার একটি সুযোগ মাত্র।", author: "হেনরি ফোর্ড" },
            { text: "সাফল্যের মূলমন্ত্র হল সাধারণ জিনিসগুলোকেও অসাধারণভাবে করা।", author: "জন ডি. রকফেলার" },
            { text: "তোমার স্বপ্ন আর তোমার মাঝে দাঁড়িয়ে আছে কেবল একটি জিনিস— সেটি হলো অজুহাত!", author: "জর্ডান বেলফোর্ট" },
            { text: "ভবিষ্যৎ তাদেরই যারা তাদের স্বপ্নের সৌন্দর্যে বিশ্বাস করে।", author: "এলেনর রুজভেল্ট" },
            { text: "সফলতা চূড়ান্ত নয়, ব্যর্থতা মারাত্মক নয়: চালিয়ে যাওয়ার সাহসটাই আসল।", author: "উইনস্টন চার্চিল" },
            { text: "যতক্ষণ না কাজ শেষ হয়, ততক্ষণ পর্যন্ত তা অসম্ভব বলে মনে হয়।", author: "নেলসন ম্যান্ডেলা" },
            { text: "চমৎকার কাজ করার একমাত্র উপায় হল আপনি যা করেন তা ভালবাসা।", author: "স্টিভ জবস" },
    ];


    // --- *** GEMINI API HELPER FUNCTION *** ---
    async function callGeminiAPI(prompt) {
        // IMPORTANT: Leave apiKey as an empty string. The hosting environment will inject it.
        const apiKey = "";
        const model = 'gemini-2.5-flash-preview-09-2025'; // Using the Flash model
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            // Optional: Add safety settings if needed
            // safetySettings: [
            //     { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
            //     { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
            //     // Add other categories as needed
            // ]
        };

        let attempts = 0;
        const maxAttempts = 5;
        let delay = 1000; // 1 second initial delay

        while (attempts < maxAttempts) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Check for retryable status codes (429 Too Many Requests, 5xx Server Errors)
                    if (response.status === 429 || response.status >= 500) {
                        console.warn(`Gemini API request failed with status ${response.status}. Retrying in ${delay / 1000}s... (Attempt ${attempts + 1}/${maxAttempts})`);
                        // Don't log retries as errors in the console
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        attempts++;
                        continue; // Go to the next attempt
                    } else {
                        // Other client-side errors (400, 401, 403, etc.) - don't retry
                        console.error(`Gemini API request failed with non-retryable status ${response.status}:`, await response.text());
                        throw new Error(`API request failed: ${response.statusText} (${response.status})`);
                    }
                }

                const result = await response.json();
                console.log("Gemini API Response:", result); // Log the full response for debugging

                const candidate = result.candidates?.[0];

                if (candidate) {
                    // Check finish reason and safety ratings *before* accessing content
                    if (candidate.finishReason && candidate.finishReason !== 'STOP' && candidate.finishReason !== 'MAX_TOKENS') {
                         console.error(`Content generation stopped unexpectedly. Reason: ${candidate.finishReason}`);
                         throw new Error(`Content generation failed: ${candidate.finishReason}`);
                    }
                     if (candidate.safetyRatings?.some(rating => rating.probability !== 'NEGLIGIBLE')) {
                         console.warn("Content may be blocked or adjusted due to safety ratings:", candidate.safetyRatings);
                         // Decide how to handle potentially blocked content (e.g., show a message or use fallback)
                         // For now, we'll try to return the text if it exists, but log the warning.
                     }

                    // Attempt to get the text content
                    const textContent = candidate.content?.parts?.[0]?.text;
                    if (textContent) {
                        return textContent; // Success!
                    } else {
                        // Handle cases where content is missing even if finishReason is STOP
                        console.error("No text content found in Gemini response candidate, despite successful status and finish reason.", candidate);
                         throw new Error("API returned a candidate, but no text content was found.");
                    }
                } else if (result.promptFeedback?.blockReason) {
                    // Handle cases where the entire prompt was blocked
                     console.error(`Prompt blocked by API. Reason: ${result.promptFeedback.blockReason}`, result.promptFeedback);
                     throw new Error(`Your request was blocked due to safety concerns (${result.promptFeedback.blockReason}). Please modify your input.`);

                } else {
                     // Handle other unexpected response structures
                     console.error("Unexpected response structure from Gemini API. No candidates found.", result);
                     throw new Error("No content generated or unexpected API response structure.");
                }

            } catch (error) {
                console.error(`Error during Gemini API call attempt ${attempts + 1}:`, error);
                // Don't retry if it's a non-retryable HTTP error caught earlier or a prompt block
                if (error.message.includes("API request failed:") || error.message.includes("request was blocked")) {
                     throw error; // Re-throw immediately
                }

                if (attempts >= maxAttempts - 1) {
                    console.error("Gemini API call failed after multiple retries.");
                    throw error; // Re-throw the final error after max retries
                }
                // If it wasn't a retryable error caught above, still wait and retry for network issues etc.
                console.warn(`Retrying Gemini API call in ${delay / 1000}s after error: ${error.message}`);
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
                attempts++;
            }
        }
        // This line should technically not be reached if errors are thrown correctly
        throw new Error("Gemini API call failed after multiple retries.");
    }
    // --- *** END GEMINI API HELPER *** ---


    document.addEventListener('DOMContentLoaded', function() {

        // --- SET RANDOM BACKGROUND IMAGE ---
        const backgroundImages = [
            'https://images.pexels.com/photos/2041540/pexels-photo-2041540.jpeg?auto=compress&cs=tinysrgb&w=1920',
            'https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg?auto=compress&cs=tinysrgb&w=1920',
            'https://images.pexels.com/photos/3747505/pexels-photo-3747505.jpeg?auto=compress&cs=tinysrgb&w=1920',
            'https://images.pexels.com/photos/267507/pexels-photo-267507.jpeg?auto=compress&cs=tinysrgb&w=1920',
            'https://images.pexels.com/photos/1181298/pexels-photo-1181298.jpeg?auto=compress&cs=tinysrgb&w=1920',
            'https://images.pexels.com/photos/1595385/pexels-photo-1595385.jpeg?auto=compress&cs=tinysrgb&w=1920',
            'https://images.pexels.com/photos/3184360/pexels-photo-3184360.jpeg?auto=compress&cs=tinysrgb&w=1920',
            'https://images.pexels.com/photos/669615/pexels-photo-669615.jpeg?auto=compress&cs=tinysrgb&w=1920',
        ];
        const randomIndex = Math.floor(Math.random() * backgroundImages.length);
        document.body.style.backgroundImage = `url('${backgroundImages[randomIndex]}')`;

        // --- THEME MANAGEMENT ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

        function applyTheme(isDark, triggeredByListener = false) {
             console.log("Applying theme. Is dark:", isDark, "Triggered by listener:", triggeredByListener);
             document.documentElement.classList.toggle('dark', isDark);
             themeIconLight.classList.toggle('hidden', isDark);
             themeIconDark.classList.toggle('hidden', !isDark);
             // Apply SweetAlert theme based on body class
             const swalTheme = isDark ? 'dark' : 'default';
             // No direct theme option, rely on CSS variables or class toggles

              if (initialLoadComplete && (views.dashboard.offsetParent !== null)) {
                   console.log("Theme changed, rendering charts.");
                   renderWeeklyChart(true);
                   renderTodayPieChart(true);
              }
        }
        const currentTheme = localStorage.getItem('theme');
        const initialDark = currentTheme === 'dark' || (!currentTheme && prefersDark.matches);
        applyTheme(initialDark, false);
        themeToggle.addEventListener('click', () => {
             const isDark = !document.documentElement.classList.contains('dark');
             localStorage.setItem('theme', isDark ? 'dark' : 'light');
             applyTheme(isDark, true);
        });

        // --- Default User Data ---
        const createNewUserData = (user) => ({
             uid: user.uid, email: user.email, profile: { name: user.displayName || '', mobile: user.phoneNumber || '', class: '', institution: '', motivation: '', profileImg: user.photoURL || 'https://placehold.co/128x128/E2E8F0/4A5568?text=%E0%A6%9B%E0%A6%AC%E0%A6%BF' }, studySession: { isActive: false, startTime: null, subject: '', topic: '' }, studyHistory: [], dailyGoal: 7, points: 0, badges: []
        });

        // --- UI ELEMENTS ---
        const views = {
            login: document.getElementById('login-view'),
            dashboard: document.getElementById('dashboard-view'),
            profile: document.getElementById('profile-view'),
            about: document.getElementById('about-view')
        };
        const navItems = { sidebar: document.getElementById('sidebar-nav').parentElement, mobile: document.getElementById('mobile-nav'), logoutBtn: document.getElementById('logout-button') };
        const navDashboard = document.getElementById('nav-dashboard'),
              navProfile = document.getElementById('nav-profile'),
              navAbout = document.getElementById('nav-about');
        const mobileNavDashboard = document.getElementById('mobile-nav-dashboard'),
              mobileNavProfile = document.getElementById('mobile-nav-profile'),
              mobileNavAbout = document.getElementById('mobile-nav-about'),
              mobileLogoutBtn = document.getElementById('mobile-logout-button');
        const loginEmailInput = document.getElementById('login-email'), loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button'), googleLoginButton = document.getElementById('google-login-button');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const dailyGoalInput = document.getElementById('daily-goal'), subjectInput = document.getElementById('subject'), topicInput = document.getElementById('topic');
        const startBtn = document.getElementById('start-btn'), stopBtn = document.getElementById('stop-btn');
        const timerDisplay = document.getElementById('timer'), todayTotalDisplay = document.getElementById('today-total'), todayRemainingDisplay = document.getElementById('today-remaining');
        const progressBar = document.getElementById('progress-bar'), historyLog = document.getElementById('history-log');
        const subjectSummaryList = document.getElementById('subject-summary-list');
        const rankEmojiDisplay = document.getElementById('rank-emoji');
        const rankNameDisplay = document.getElementById('rank-name');
        const todayPointsDisplay = document.getElementById('today-points');
        const weeklyPointsDisplay = document.getElementById('weekly-points');
        const profileImgDisplay = document.getElementById('profile-img-display'), profileImgUpload = document.getElementById('profile-img-upload'), imgUploadSpinner = document.getElementById('img-upload-spinner');
        const profileNameInput = document.getElementById('profile-name'), profileEmailInput = document.getElementById('profile-email'), profileMobileInput = document.getElementById('profile-mobile');
        const profileClassInput = document.getElementById('profile-class'), profileInstitutionInput = document.getElementById('profile-institution'), profileMotivationInput = document.getElementById('profile-motivation');
        const saveProfileBtn = document.getElementById('save-profile');
        const profilePointsDisplay = document.getElementById('profile-points');
        const profileRankEmojiDisplay = document.getElementById('profile-rank-emoji');
        const profileRankNameDisplay = document.getElementById('profile-rank-name');
        const profileWeeklyPointsDisplay = document.getElementById('profile-weekly-points');
        const profileBadgesContainer = document.getElementById('profile-badges');
        const quoteTextEl = document.getElementById('quote-text'), quoteAuthorEl = document.getElementById('quote-author'); // Renamed for clarity
        const getTopicDetailsBtn = document.getElementById('get-topic-details-btn'); // Gemini Button


        // --- DATA PERSISTENCE (Firebase) ---
        function setupFirestoreListener(user) {
             userDocRef = doc(db, 'users', user.uid); initialLoadComplete = false;
             if (firestoreUnsubscribe) { firestoreUnsubscribe(); firestoreUnsubscribe = null; }
             firestoreUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                 const isFirstData = !initialLoadComplete; const previousHistoryLength = state?.studyHistory?.length ?? 0;
                 if (docSnap.exists()) {
                     state = docSnap.data();
                     // Ensure defaults
                     state.points = typeof state.points === 'number' ? state.points : 0; state.badges = Array.isArray(state.badges) ? state.badges : []; state.studyHistory = Array.isArray(state.studyHistory) ? state.studyHistory : []; state.profile = state.profile || createNewUserData(user).profile; state.studySession = state.studySession || { isActive: false, startTime: null, subject: '', topic: '' }; state.dailyGoal = typeof state.dailyGoal === 'number' ? state.dailyGoal : 7;
                     const historyDataChanged = state.studyHistory.length !== previousHistoryLength;
                     loadAndDisplayUserData(isFirstData, historyDataChanged);
                     if (isFirstData) {
                         const { rank } = calculateWeeklyStats(); // Calculate initial rank
                         previousRankName = rank.name;
                         showView('dashboard');
                         initialLoadComplete = true;
                     }
                 } else {
                     const newUserData = createNewUserData(user); setDoc(userDocRef, newUserData).then(() => {
                         state = newUserData;
                         previousRankName = ranks[0].name;
                         loadAndDisplayUserData(true, true);
                         showView('dashboard');
                         initialLoadComplete = true;
                     }).catch(err => { console.error("Error creating user data:", err); Swal.fire({ icon: 'error', title: 'সমস্যা', text: 'ব্যবহারকারীর ডেটা তৈরি করা যায়নি।' }); initialLoadComplete = true; });
                 }
             }, (error) => { console.error("Error listening to Firestore:", error); Swal.fire({ icon: 'error', title: 'Connection সমস্যা', text: 'ডেটাবেসের সাথে সংযোগ বিচ্ছিন্ন হয়েছে।' }); initialLoadComplete = true; });
        }


        // --- NAVIGATION & VIEWS ---
        function showView(viewName) {
             console.log("Showing view:", viewName);
             const currentView = Object.keys(views).find(key => !views[key].classList.contains('hidden'));
             if (currentView === viewName && !views[viewName].classList.contains('hidden')) { console.log("Already on view:", viewName); return; }
             Object.values(views).forEach(view => view.classList.add('hidden'));
             if(views[viewName]) views[viewName].classList.remove('hidden');
             updateNavActiveState(viewName);
              if (viewName === 'dashboard' && initialLoadComplete) {
                  console.log("Dashboard view shown, rendering charts.");
                  renderWeeklyChart(false);
                  renderTodayPieChart(false);
              }
        }

        async function updateUIAfterLogin() { // Added async for await updateQuote
             console.log("Updating UI for logged-in state.");
             // navItems.sidebar.classList.remove('hidden'); // *** REMOVED THIS LINE ***
             navItems.sidebar.classList.add('md:flex'); // This ensures it's only flex on medium screens and up
             navItems.mobile.classList.add('flex');
             navItems.mobile.classList.remove('hidden');
             navItems.logoutBtn.classList.remove('hidden');
             await updateQuote(); // Load initial quote via API
             if(quoteInterval) clearInterval(quoteInterval);
             quoteInterval = setInterval(updateQuote, 60000); // Fetch new quote every 60 seconds
        }

        function updateUIAfterLogout() {
             console.log("Updating UI for logged-out state.");
             if (firestoreUnsubscribe) { firestoreUnsubscribe(); firestoreUnsubscribe = null; }
             currentUser = null; state = null; userDocRef = null; initialLoadComplete = false;
             previousRankName = null;

             navItems.sidebar.classList.add('hidden'); // Ensure it's hidden
             navItems.sidebar.classList.remove('md:flex'); // Remove the medium screen display class
             navItems.mobile.classList.remove('flex');
             navItems.mobile.classList.add('hidden');
             navItems.logoutBtn.classList.add('hidden');

             showView('login');
             loginEmailInput.value = ''; loginPasswordInput.value = '';
             if(quoteInterval) clearInterval(quoteInterval);
             quoteTextEl.textContent = ''; quoteAuthorEl.textContent = ''; // Clear quote
             if (timerInterval) clearInterval(timerInterval); timerInterval = null;
             timerDisplay.textContent = '00:00:00'; todayTotalDisplay.textContent = '0 ঘন্টা 0 মিনিট'; todayRemainingDisplay.textContent = '0 ঘন্টা 0 মিনিট';
             progressBar.style.width = '0%';
             historyLog.innerHTML = '<p class="text-main-secondary">এখনও কোনো টপিক সম্পন্ন হয়নি।</p>';
             subjectSummaryList.innerHTML = '<p class="text-main-secondary text-center py-2">এখনও কোনো সেশন সম্পন্ন হয়নি।</p>';
             rankEmojiDisplay.textContent = ranks[0].emoji; rankNameDisplay.textContent = ranks[0].name; todayPointsDisplay.textContent = '0.00'; weeklyPointsDisplay.textContent = '0.00';
              if (weeklyChartInstance) { weeklyChartInstance.destroy(); weeklyChartInstance = null; }
              if (todayPieChartInstance) { todayPieChartInstance.destroy(); todayPieChartInstance = null; }
        }

        function updateNavActiveState(activeView) {
             [navDashboard, navProfile, navAbout].forEach(el => el.classList.remove('active'));
             if (activeView === 'dashboard') navDashboard.classList.add('active');
             else if (activeView === 'profile') navProfile.classList.add('active');
             else if (activeView === 'about') navAbout.classList.add('active');

             [mobileNavDashboard, mobileNavProfile, mobileNavAbout].forEach(el => {
                 el.classList.remove('text-blue-600', 'dark:text-blue-400');
                 el.classList.add('text-gray-500', 'dark:text-gray-400');
             });
             let activeMobileNav = null;
             if (activeView === 'dashboard') activeMobileNav = mobileNavDashboard;
             else if (activeView === 'profile') activeMobileNav = mobileNavProfile;
             else if (activeView === 'about') activeMobileNav = mobileNavAbout;

             if(activeMobileNav) {
                 activeMobileNav.classList.remove('text-gray-500', 'dark:text-gray-400');
                 activeMobileNav.classList.add('text-blue-600', 'dark:text-blue-400');
             }
        }

        // --- AUTHENTICATION (Firebase) ---
        onAuthStateChanged(auth, (user) => {
             console.log("Auth state changed. User:", user ? user.uid : "null");
             if (user) {
                 if (!currentUser || currentUser.uid !== user.uid) {
                     currentUser = user;
                     updateUIAfterLogin(); // Now async
                     setupFirestoreListener(user);
                 } else {
                      if (initialLoadComplete && views.login.offsetParent !== null) {
                           console.log("User already logged in, showing dashboard.");
                           showView('dashboard');
                      }
                 }
             } else {
                 if (currentUser != null) {
                     updateUIAfterLogout();
                 } else {
                     console.log("Initial state: User not logged in.");
                     if (views.login.offsetParent === null) {
                         showView('login');
                     }
                      // This ensures sidebar is hidden on initial load if not logged in
                      navItems.sidebar.classList.add('hidden');
                      navItems.sidebar.classList.remove('md:flex');
                      navItems.mobile.classList.add('hidden');
                 }
             }
        });


        // Email/Password login/create
        async function handleLogin() {
             const email = loginEmailInput.value.trim().toLowerCase(); const password = loginPasswordInput.value;
             if (!email || !password || !email.includes('@')) { Swal.fire({ icon: 'error', title: 'ভুল তথ্য', text: 'সঠিক ইমেইল ও পাসওয়ার্ড দিন।' }); return; }
             try { await signInWithEmailAndPassword(auth, email, password); console.log("Login successful"); }
             catch (signInError) {
                 console.error("Sign-in failed:", signInError.code);
                 if (['auth/invalid-credential', 'auth/invalid-login-credentials', 'auth/wrong-password', 'auth/user-not-found', 'auth/invalid-email'].includes(signInError.code)) { // Added invalid-email
                     // Try creating account only if it looks like a user/password issue, not general failure
                    if (['auth/invalid-credential', 'auth/invalid-login-credentials', 'auth/wrong-password', 'auth/user-not-found'].includes(signInError.code)) {
                        try { await createUserWithEmailAndPassword(auth, email, password); console.log("Signup successful"); }
                        catch (createError) {
                            console.error("Signup failed:", createError.code);
                            let msg = createError.message;
                            if (createError.code === 'auth/email-already-in-use') { msg = 'ভুল পাসওয়ার্ড অথবা এই ইমেইল দিয়ে আগেই অ্যাকাউন্ট খোলা হয়েছে।'; }
                            else if (createError.code === 'auth/weak-password') { msg = 'পাসওয়ার্ডটি অন্তত ৬ অক্ষর দীর্ঘ হতে হবে।'; }
                            else if (createError.code === 'auth/invalid-email') { msg = 'দয়া করে একটি সঠিক ইমেইল ঠিকানা লিখুন।'; }
                            else { msg = `অ্যাকাউন্ট তৈরি করা যায়নি: ${createError.code}`; }
                            Swal.fire({ icon: 'error', title: 'Login/Signup সমস্যা', text: msg });
                        }
                    } else { // Handle invalid email specifically during login attempt
                         Swal.fire({ icon: 'error', title: 'Login সমস্যা', text: 'দয়া করে একটি সঠিক ইমেইল ঠিকানা লিখুন।' });
                    }
                 } else {
                     // Handle other sign-in errors
                     Swal.fire({ icon: 'error', title: 'Login-এ সমস্যা', text: `পুনরায় চেষ্টা করুন (${signInError.code})` });
                 }
             }
        }

        // Google login
        async function handleGoogleLogin() {
             try { await signInWithPopup(auth, provider); } catch (error) { console.error("Google login error:", error); let msg = error.message; if (error.code === 'auth/popup-closed-by-user') msg = 'Google সাইন-ইন পপআপ বন্ধ করা হয়েছে।'; else if (error.code === 'auth/cancelled-popup-request') msg = 'একাধিক সাইন-ইন পপআপ খোলার চেষ্টা করা হয়েছে।'; Swal.fire({ icon: 'error', title: 'Google Login-এ সমস্যা', text: msg }); }
        }

        // Password Reset
        async function handlePasswordReset() {
             const { value: email } = await Swal.fire({ title: 'পাসওয়ার্ড রিসেট', input: 'email', inputLabel: 'আপনার অ্যাকাউন্টের ইমেইল', inputPlaceholder: 'email@example.com', showCancelButton: true, confirmButtonText: 'লিংক পাঠান', cancelButtonText: 'বাতিল' });
              if (email) {
                  try { await sendPasswordResetEmail(auth, email); Swal.fire({ icon: 'success', title: 'লিংক পাঠানো হয়েছে!', text: `আপনার ইমেইল (${email}) চেক করুন।` }); } catch (error) { console.error("Password reset error:", error); let msg = 'লিংক পাঠানো যায়নি।'; if (['auth/user-not-found', 'auth/invalid-email'].includes(error.code)) { msg += ' ইমেইল ঠিকানাটি সঠিক কিনা দেখুন।'; } else { msg += ` (${error.code})`; } Swal.fire({ icon: 'error', title: 'সমস্যা', text: msg }); }
              }
        }

        // Logout
        function handleLogout() {
             console.log("Logout initiated..."); const isActiveSession = state?.studySession?.isActive;
             if (isActiveSession) { stopTimer(false).finally(() => { signOut(auth).catch(err => console.error("Sign out error:", err)); }); }
             else { signOut(auth).catch(err => console.error("Sign out error:", err)); }
        }

        // --- CORE LOGIC ---
        async function startTimer() {
             if (!subjectInput.value.trim() || !topicInput.value.trim()) { Swal.fire({ icon: 'warning', title: 'দুঃখিত!', text: 'বিষয় এবং টপিক লিখুন।' }); return; } if (!userDocRef) { Swal.fire({ icon: 'error', title: 'সমস্যা', text: 'ব্যবহারকারীর ডেটা লোড হয়নি।' }); return; }
             const sessionData = { isActive: true, startTime: Date.now(), subject: subjectInput.value.trim(), topic: topicInput.value.trim() };
             try { await updateDoc(userDocRef, { studySession: sessionData }); console.log("Timer started."); } catch (error) { console.error("Error starting timer:", error); Swal.fire({ icon: 'error', title: 'সমস্যা', text: 'টাইমার শুরু করা যায়নি।' }); }
        }

        async function stopTimer(showCongratsPopup = true) {
             return new Promise(async (resolve, reject) => {
                 if (!state?.studySession?.isActive || !userDocRef) { resolve(); return; }
                 const startTime = state.studySession.startTime; if (startTime === null) { try { await updateDoc(userDocRef, { studySession: { isActive: false, startTime: null, subject: '', topic: '' }}); resolve(); } catch (e) { reject(e); } return; }
                 const duration = Math.round((Date.now() - startTime) / 1000); const pointsEarned = parseFloat((duration / 3600).toFixed(2));
                 if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
                 // Minimum duration check (e.g., 10 seconds) - optional
                 // if (duration < 10) {
                 //     try { await updateDoc(userDocRef, { studySession: { isActive: false, startTime: null, subject: '', topic: '' } }); resolve(); } catch(e) { reject(e); }
                 //     Swal.fire({ icon: 'info', title: 'Session Too Short', text: 'Study session was too short to save.', timer: 2000 });
                 //     return;
                 // }
                 if (duration <= 0) { try { await updateDoc(userDocRef, { studySession: { isActive: false, startTime: null, subject: '', topic: '' } }); resolve(); } catch(e) { reject(e); } return; }

                 const sessionHistory = { date: new Date().toISOString(), subject: state.studySession.subject || 'N/A', topic: state.studySession.topic || 'N/A', duration: duration };
                 try {
                     const updateData = { studySession: { isActive: false, startTime: null, subject: '', topic: '' }, points: increment(pointsEarned) };
                     if (Array.isArray(state.studyHistory)) { updateData.studyHistory = arrayUnion(sessionHistory); } else { updateData.studyHistory = [sessionHistory]; }
                     await updateDoc(userDocRef, updateData); console.log("Session stopped. Points Earned (hours):", pointsEarned);
                     startBtn.classList.remove('hidden'); stopBtn.classList.add('hidden'); [subjectInput, topicInput, dailyGoalInput, getTopicDetailsBtn].forEach(el => el.disabled = false); subjectInput.value = ''; topicInput.value = ''; timerDisplay.textContent = '00:00:00';

                     if (showCongratsPopup) {
                         setTimeout(() => {
                             getDoc(userDocRef).then(docSnap => {
                                 if (docSnap.exists()) {
                                     const latestState = docSnap.data();
                                     const todayStr = getLocalDateString();
                                     const totalSecondsTodayLatest = (latestState.studyHistory || [])
                                         .filter(e => e?.date && typeof e.duration === 'number' && e.duration > 0 && getLocalDateString(new Date(e.date)) === todayStr)
                                         .reduce((sum, e) => sum + e.duration, 0);
                                     const goalSeconds = (latestState.dailyGoal || 7) * 3600;

                                     if (goalSeconds > 0 && totalSecondsTodayLatest >= goalSeconds) {
                                         // Check if goal was *just* met or already met before this session
                                         const secondsBeforeThisSession = totalSecondsTodayLatest - duration;
                                         if (secondsBeforeThisSession < goalSeconds) {
                                             Swal.fire({ icon: 'success', title: 'অভিনন্দন!', text: 'আপনি আজকের পড়ার লক্ষ্য পূরণ করেছেন!' });
                                             if (!latestState.badges?.includes('goal_achiever')) {
                                                 updateDoc(userDocRef, { badges: arrayUnion('goal_achiever') }).then(() => console.log("Goal Achiever badge awarded.")).catch(err => console.error("Error awarding goal badge:", err));
                                             }
                                         }
                                     }
                                     checkAndAwardBadges(latestState);
                                 }
                             }).catch(err => console.error("Error fetching doc for goal/badge check:", err));
                         }, 600);
                     }
                     updateDashboardUIOnly();
                     resolve();
                 } catch (error) { console.error("Error stopping timer:", error); Swal.fire({ icon: 'error', title: 'সমস্যা', text: 'সেশন সেভ করা যায়নি।' }); reject(error); }
             });
        }

        async function checkAndAwardBadges(updatedState) {
            if (!userDocRef || !updatedState) return;
            const newBadges = [];
            const currentPoints = updatedState.points || 0;
            const currentBadges = updatedState.badges || [];
            for (const key in badges) {
                const badge = badges[key];
                if (badge.type === 'points') {
                    if (currentPoints >= badge.threshold && !currentBadges.includes(key)) {
                        newBadges.push(key);
                    }
                }
            }
            if (newBadges.length > 0) {
                try {
                    await updateDoc(userDocRef, { badges: arrayUnion(...newBadges) });
                    console.log("Awarded new badges:", newBadges);
                    newBadges.forEach((badgeKey, index) => {
                        const badge = badges[badgeKey];
                        setTimeout(() => {
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: `নতুন ব্যাজ অর্জিত! ${badge.emoji}`,
                                html: `আপনি <strong>"${badge.name}"</strong> ব্যাজটি পেয়েছেন!`,
                                timer: 5000,
                                timerProgressBar: true,
                                showConfirmButton: false,
                            });
                        }, index * 1000);
                    });
                } catch (err) { console.error("Error awarding badges:", err); }
            }
        }

        function showRankUpToast(rank) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'অভিনন্দন! 🥳',
                html: `আপনি <strong>${rank.name} ${rank.emoji}</strong> র‍্যাঙ্কে পৌঁছেছেন!`,
                timer: 15000,
                timerProgressBar: true,
                showConfirmButton: false,
                allowOutsideClick: true,
                allowEscapeKey: true,
            });
        }


        function updateTimerDisplay() {
             if (!state?.studySession?.isActive || state.studySession.startTime === null) { if (timerInterval) clearInterval(timerInterval); timerInterval = null; timerDisplay.textContent = '00:00:00'; return; }; const elapsed = Math.round((Date.now() - state.studySession.startTime) / 1000); timerDisplay.textContent = formatTime(Math.max(0, elapsed));
        }

        const formatTime = (s) => `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor(s%3600/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        const formatDuration = (s) => {
             if (typeof s !== 'number' || isNaN(s) || s < 0) return '0 মিনিট'; const h=Math.floor(s/3600), m=Math.floor(s%3600/60); return `${h>0?h+' ঘন্টা ':''}${m>0?m+' মিনিট':''}`.trim() || (s > 0 ? '1 মিনিটের কম' : '0 মিনিট');
        };
        const getLocalDateString = (date = new Date()) => {
             try { if (!(date instanceof Date) || isNaN(date.getTime())) date = new Date(); const y = date.getFullYear(), m = String(date.getMonth() + 1).padStart(2, '0'), d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; } catch (e) { console.error("Date format error:", e); return 'date-error'; }
        };
        const getTotalStudiedSecondsForToday = () => {
             if (!state?.studyHistory) return 0; const todayStr = getLocalDateString(); return (state.studyHistory || []).filter(e => e?.date && typeof e.duration === 'number' && e.duration > 0 && getLocalDateString(new Date(e.date)) === todayStr).reduce((sum, e) => sum + e.duration, 0);
        };
        function getWeekBoundaries(date = new Date()) {
             const currentDay = date.getDay();
             // Adjust calculation: Saturday is 6, Sunday is 0. If today is Saturday (6), daysToSaturday should be 0. If Sunday (0), it should be 1.
             // daysToSaturday should calculate days *since* last Saturday (inclusive) or days *until* next Friday (inclusive)? Let's assume week starts Saturday, ends Friday.
             // Day: S M T W T F S
             // Num: 0 1 2 3 4 5 6
             // If today is Sunday(0), Saturday was 1 day ago.
             // If today is Monday(1), Saturday was 2 days ago.
             // If today is Friday(5), Saturday was 6 days ago.
             // If today is Saturday(6), Saturday was 0 days ago.
             const daysSinceSaturday = currentDay === 6 ? 0 : currentDay + 1; // Correction needed

             const startDate = new Date(date);
             // startDate.setDate(date.getDate() - daysSinceSaturday); // This logic might be slightly off depending on start day
             // Let's use a simpler approach: find the *previous* Saturday or *current* Saturday
             const diff = date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1) - 1; // Adjust to find *last* Saturday? No, let's target Saturday as day 0.
             // Let Sunday = 0, Monday = 1, ..., Saturday = 6
             // Days to subtract to get to the *previous* Saturday:
             const daysToSubtract = (currentDay + 1) % 7; // Sunday(0)->1, Mon(1)->2, ..., Sat(6)->0
             startDate.setDate(date.getDate() - daysToSubtract);


             startDate.setHours(0, 0, 0, 0);

             const endDate = new Date(startDate);
             endDate.setDate(startDate.getDate() + 6); // Saturday + 6 days = Friday
             endDate.setHours(23, 59, 59, 999);
             // console.log("Week Boundaries:", startDate.toDateString(), "-", endDate.toDateString()); // For debugging
             return { start: startDate, end: endDate };
        }
        function calculateWeeklyStats() {
             if (!state?.studyHistory) return { rank: ranks[0], weeklyHours: 0, weeklyPoints: 0, todayPoints: 0 }; const { start, end } = getWeekBoundaries(); const startTime = start.getTime(); const endTime = end.getTime(); const todayStr = getLocalDateString(); let weeklySeconds = 0, todaySeconds = 0;
             (state.studyHistory || []).forEach(e => { if (e?.date && typeof e.duration === 'number' && e.duration > 0) { try { const entryDate = new Date(e.date); if (isNaN(entryDate.getTime())) return; const entryTime = entryDate.getTime(); if (entryTime >= startTime && entryTime <= endTime) { weeklySeconds += e.duration; if (getLocalDateString(entryDate) === todayStr) { todaySeconds += e.duration; } } } catch (err) { console.error("Date parse error:", e.date, err); } } });
             const weeklyHours = weeklySeconds / 3600; const weeklyPoints = parseFloat(weeklyHours.toFixed(2)); const todayPoints = parseFloat((todaySeconds / 3600).toFixed(2)); let currentRank = ranks[0]; for (let i = ranks.length - 1; i >= 0; i--) { if (weeklyHours >= ranks[i].minHours) { currentRank = ranks[i]; break; } } return { rank: currentRank, weeklyHours, weeklyPoints, todayPoints };
        }

        // --- UI UPDATES ---
        function loadAndDisplayUserData(isInitialLoad = false, historyDataChanged = false) {
             if (!state || !currentUser) { console.warn("loadAndDisplayUserData: State/User null."); return; }
             console.log("loadAndDisplayUserData called. Initial:", isInitialLoad, "History Changed:", historyDataChanged);
             state.profile = state.profile || createNewUserData(currentUser).profile; state.studySession = state.studySession || { isActive: false, startTime: null, subject: '', topic: '' }; state.studyHistory = Array.isArray(state.studyHistory) ? state.studyHistory : []; state.dailyGoal = typeof state.dailyGoal === 'number' ? state.dailyGoal : 7; state.points = typeof state.points === 'number' ? state.points : 0; state.badges = Array.isArray(state.badges) ? state.badges : [];

             const { rank: newRank } = calculateWeeklyStats();
             if (previousRankName && newRank.name !== previousRankName && newRank.name !== 'Bronze') {
                 const newRankIndex = ranks.findIndex(r => r.name === newRank.name);
                 const oldRankIndex = ranks.findIndex(r => r.name === previousRankName);
                 if (newRankIndex > oldRankIndex) {
                     showRankUpToast(newRank);
                 }
             }
             previousRankName = newRank.name;

             updateDashboardUIOnly();
             updateProfilePage();
             dailyGoalInput.value = state.dailyGoal;

             if (state.studySession.isActive && state.studySession.startTime !== null) {
                 startBtn.classList.add('hidden'); stopBtn.classList.remove('hidden');
                 subjectInput.value = state.studySession.subject || ''; topicInput.value = state.studySession.topic || '';
                 [subjectInput, topicInput, dailyGoalInput, getTopicDetailsBtn].forEach(el => el.disabled = true); // Disable Gemini btn too
                 if (timerInterval) clearInterval(timerInterval); updateTimerDisplay(); timerInterval = setInterval(updateTimerDisplay, 1000);
             } else {
                  if (timerInterval) clearInterval(timerInterval); timerInterval = null; timerDisplay.textContent = '00:00:00';
                  startBtn.classList.remove('hidden'); stopBtn.classList.add('hidden');
                  [subjectInput, topicInput, dailyGoalInput, getTopicDetailsBtn].forEach(el => el.disabled = false); // Enable Gemini btn
                  if (!state.studySession.isActive) { subjectInput.value = ''; topicInput.value = ''; }
             }

              if (isInitialLoad || historyDataChanged) {
                  console.log("Rendering charts.");
                  renderWeeklyChart(false);
                  renderTodayPieChart(false);
              }
        }


        function updateDashboardUIOnly() {
             if (!state) { console.warn("updateDashboardUIOnly: State is null."); return; }
             const totalSecondsToday = getTotalStudiedSecondsForToday(); const goalSeconds = (state.dailyGoal || 7) * 3600; todayTotalDisplay.textContent = formatDuration(totalSecondsToday); todayRemainingDisplay.textContent = formatDuration(Math.max(0, goalSeconds - totalSecondsToday)); progressBar.style.width = `${goalSeconds > 0 ? Math.min(100, (totalSecondsToday / goalSeconds) * 100) : 0}%`;
             const todayStr = getLocalDateString(); const todayHistory = (state.studyHistory || []).filter(e => e?.date && getLocalDateString(new Date(e.date)) === todayStr) || []; historyLog.innerHTML = todayHistory.length > 0 ? todayHistory.slice().reverse().map(e => `<div class="p-3 history-item rounded-lg"><p class="history-item-subject">${e.subject || 'N/A'}: <span class="history-item-topic">${e.topic || 'N/A'}</span></p><p class="text-sm history-item-time">সময়: ${formatDuration(e.duration || 0)}</p></div>`).join('') : '<p class="text-main-secondary">এখনও কোনো টপিক সম্পন্ন হয়নি।</p>';
             const subjectTimes = {}; todayHistory.forEach(e => { if (e?.subject && typeof e.duration === 'number' && e.duration > 0) { subjectTimes[e.subject] = (subjectTimes[e.subject] || 0) + e.duration; } });
             if (Object.keys(subjectTimes).length > 0) { subjectSummaryList.innerHTML = Object.entries(subjectTimes).sort(([, a], [, b]) => b - a).map(([sub, dur]) => `<div class="subject-summary-item"><span class="font-medium text-main-primary">${sub}</span><span class="text-main-secondary">${formatDuration(dur)}</span></div>`).join(''); } else { subjectSummaryList.innerHTML = '<p class="text-main-secondary text-center py-2">এখনও কোনো সেশন সম্পন্ন হয়নি।</p>'; }
             const { rank, weeklyPoints, todayPoints } = calculateWeeklyStats(); rankEmojiDisplay.textContent = rank.emoji; rankNameDisplay.textContent = rank.name; todayPointsDisplay.textContent = todayPoints.toFixed(2); weeklyPointsDisplay.textContent = weeklyPoints.toFixed(2);
        }

        // --- Chart Rendering Function ---
        function renderWeeklyChart(themeChangeOnly = false) {
             if (!state || !Array.isArray(state.studyHistory) || !weeklyChartCanvas) return; const ctx = weeklyChartCanvas.getContext('2d'); if (!ctx) return;
             const today = new Date(); const dayLabels = []; const weeklyData = Array(7).fill(0); const { start } = getWeekBoundaries(today);
             for (let i = 0; i < 7; i++) {
                 const date = new Date(start); date.setDate(start.getDate() + i); const dayStr = getLocalDateString(date); dayLabels.push(date.toLocaleDateString('bn-BD', { weekday: 'short' })); const totalSeconds = (state.studyHistory || []).filter(e => e?.date && typeof e.duration === 'number' && e.duration > 0 && getLocalDateString(new Date(e.date)) === dayStr).reduce((sum, e) => sum + e.duration, 0); weeklyData[i] = parseFloat((totalSeconds / 3600).toFixed(2));
             }
             const computedStyle = getComputedStyle(document.documentElement); const gridColor = computedStyle.getPropertyValue('--chart-grid-color').trim(); const tickColor = computedStyle.getPropertyValue('--chart-tick-color').trim(); const barColor = computedStyle.getPropertyValue('--chart-bar-color').trim(); const barHoverColor = computedStyle.getPropertyValue('--chart-bar-hover-color').trim(); const chartData = { labels: dayLabels, datasets: [{ label: 'পড়ার সময় (ঘন্টা)', data: weeklyData, backgroundColor: barColor, borderColor: barColor, borderWidth: 1, hoverBackgroundColor: barHoverColor, hoverBorderColor: barHoverColor, borderRadius: 5, }]}; const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'ঘন্টা', color: tickColor, font: { family: "'Hind Siliguri', sans-serif" } }, grid: { color: gridColor }, ticks: { color: tickColor, font: { family: "'Hind Siliguri', sans-serif" } } }, x: { grid: { display: false }, ticks: { color: tickColor, font: { family: "'Hind Siliguri', sans-serif" } } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label || ''}: ${ctx.parsed.y !== null ? ctx.parsed.y + ' ঘন্টা' : ''}` } } } }; if (weeklyChartInstance) { weeklyChartInstance.destroy(); } weeklyChartInstance = new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions }); console.log("Weekly chart rendered.");
        }

        // --- Pie Chart Rendering Function ---
        function renderTodayPieChart(themeChangeOnly = false) {
            if (!state || !Array.isArray(state.studyHistory)) return;
            const pieChartCanvas = document.getElementById('todayPieChartCanvas');
            const pieChartLegend = document.getElementById('pie-chart-legend');
            if (!pieChartCanvas || !pieChartLegend) return;
            const todayStr = getLocalDateString();
            const todayHistory = (state.studyHistory || []).filter(e => e?.date && getLocalDateString(new Date(e.date)) === todayStr) || [];
            const subjectTimes = {};
            todayHistory.forEach(e => { if (e?.subject && typeof e.duration === 'number' && e.duration > 0) { subjectTimes[e.subject] = (subjectTimes[e.subject] || 0) + e.duration; } });
            if (todayPieChartInstance) { todayPieChartInstance.destroy(); todayPieChartInstance = null; }
            const labels = Object.keys(subjectTimes);
            const dataInHours = Object.values(subjectTimes).map(sec => parseFloat((sec / 3600).toFixed(2)));
            if (labels.length === 0) { pieChartCanvas.classList.add('hidden'); pieChartLegend.innerHTML = '<p>আজ কোনো বিষয় পড়া হয়নি।</p>'; return; }
            pieChartCanvas.classList.remove('hidden'); pieChartLegend.innerHTML = '';
            const pieColors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#06b6d4', '#d946ef', '#14b8a6'];
            const computedStyle = getComputedStyle(document.documentElement); const tickColor = computedStyle.getPropertyValue('--chart-tick-color').trim();
            const chartData = { labels: labels, datasets: [{ label: 'পড়ার সময় (ঘন্টা)', data: dataInHours, backgroundColor: pieColors.slice(0, labels.length).map(color => color + 'b3'), borderColor: pieColors.slice(0, labels.length), hoverOffset: 8 }]};
            const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: tickColor, font: { family: "'Hind Siliguri', sans-serif" }, padding: 15 } }, tooltip: { titleFont: { family: "'Hind Siliguri', sans-serif" }, bodyFont: { family: "'Hind Siliguri', sans-serif" }, callbacks: { label: (ctx) => { const label = ctx.label || ''; const value = ctx.parsed || 0; const total = ctx.dataset.data.reduce((acc, val) => acc + val, 0); const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0; return ` ${label}: ${value} ঘন্টা (${percentage}%)`; } } } } };
            todayPieChartInstance = new Chart(pieChartCanvas.getContext('2d'), { type: 'pie', data: chartData, options: chartOptions }); console.log("Today's pie chart rendered.");
        }

        // --- Profile Page UI Function ---
        function updateProfilePage() {
             if (!state || !currentUser) { console.warn("updateProfilePage: State/User null."); return; }
             const p = state.profile || {};
             profileEmailInput.value = currentUser.email || 'N/A';
             profileNameInput.value = p.name || ''; profileMobileInput.value = p.mobile || '';
             profileClassInput.value = p.class || ''; profileInstitutionInput.value = p.institution || '';
             profileMotivationInput.value = p.motivation || '';
             profileImgDisplay.src = p.profileImg || 'https://placehold.co/128x128/E2E8F0/4A5568?text=%E0%A6%9B%E0%A6%AC%E0%A6%BF';
             imgUploadSpinner.classList.add('hidden');
             profilePointsDisplay.textContent = (state.points || 0).toFixed(2);
             const { rank, weeklyPoints } = calculateWeeklyStats();
             profileRankEmojiDisplay.textContent = rank.emoji;
             profileRankNameDisplay.textContent = rank.name;
             profileWeeklyPointsDisplay.textContent = weeklyPoints.toFixed(2);
             if (Array.isArray(state.badges) && state.badges.length > 0) {
                 profileBadgesContainer.innerHTML = state.badges.map(badgeKey => { const badge = badges[badgeKey]; if (!badge) return ''; return `<div class="badge" title="${badge.name}"><span>${badge.emoji}</span><span>${badge.name}</span></div>`; }).join('');
             } else { profileBadgesContainer.innerHTML = '<p class="text-main-secondary text-sm">এখনও কোনো ব্যাজ অর্জন করেননি।</p>'; }
        }

        // --- *** MODIFIED: Update Quote Function (using Gemini API) *** ---
        async function updateQuote() {
            const fallbackQuote = fallbackQuotes[Math.floor(Math.random() * fallbackQuotes.length)];

            const setQuote = (text, author) => {
                // Remove surrounding quotes if present
                text = text.replace(/^["']|["']$/g, '');
                quoteTextEl.textContent = `"${text}"`;
                quoteAuthorEl.textContent = author ? `- ${author}` : '';
            };

            // Set a fallback immediately in case API fails or is slow
             setQuote(fallbackQuote.text, fallbackQuote.author);

            const prompt = "Generate a short, inspiring motivational quote in Bengali about studying, perseverance, or achieving academic goals. Format it strictly as: \"Quote text\" - Author Name. If the author is unknown or it's a general proverb, omit the ' - Author Name' part entirely. Keep the quote itself concise (around 1-2 sentences).";

            try {
                const generatedText = await callGeminiAPI(prompt);
                console.log("Generated Quote Raw:", generatedText);

                // Try to parse the generated text
                const parts = generatedText.split(' - ');
                let text = generatedText;
                let author = '';

                if (parts.length > 1) {
                    // Assume the last part is the author
                    const potentialAuthor = parts[parts.length - 1].trim();
                    // Basic check if it looks like an author name (e.g., not ending with punctuation typical of quotes)
                    if (!/[.”?!]$/.test(potentialAuthor)) {
                        author = potentialAuthor;
                        text = parts.slice(0, -1).join(' - ').trim();
                    } else {
                         // Likely no author provided, treat whole string as quote
                         text = generatedText.trim();
                         author = ''; // Explicitly clear author
                    }
                } else {
                    // No ' - ' found, assume whole string is the quote
                    text = generatedText.trim();
                    author = '';
                }

                 // Final cleanup and set
                 setQuote(text, author);


            } catch (error) {
                console.error("Error fetching quote from Gemini:", error);
                // Fallback is already set, so just log the error
            }
        }
        // --- *** END Update Quote Function *** ---

        // --- *** NEW: Gemini Topic Details Function *** ---
        async function getTopicDetails() {
            const subject = subjectInput.value.trim();
            const topic = topicInput.value.trim();
            if (!subject || !topic) {
                Swal.fire({
                    icon: 'warning',
                    title: 'অপেক্ষা করুন!',
                    text: 'অনুগ্রহ করে প্রথমে বিষয় এবং টপিক লিখুন!',
                });
                return;
            }

            // Show loading popup
            Swal.fire({
                title: 'তথ্য আনা হচ্ছে...',
                text: 'Gemini আপনার টপিকটি বিশ্লেষণ করছে।',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const prompt = `Act as a helpful study assistant. Break down the study topic '${topic}' under the subject '${subject}' into key sub-topics, concepts, or important points suitable for a student in Bangladesh. Provide the response as a bulleted list in Bengali (Bangla script). Keep the points concise and actionable for study planning. Example: For subject 'Physics' and topic 'Newton's Laws', provide points like '* প্রথম সূত্র (জড়তা)', '* দ্বিতীয় সূত্র (F=ma)', '* তৃতীয় সূত্র (ক্রিয়া-প্রতিক্রিয়া)', etc.`;

            try {
                const resultText = await callGeminiAPI(prompt);
                // Format the result for better display in SweetAlert
                const formattedHtml = resultText
                    .split('\n') // Split into lines
                    .map(line => line.trim()) // Trim whitespace
                    .filter(line => line.length > 0) // Remove empty lines
                    .map(line => `<li>${line.replace(/^\* /, '')}</li>`) // Convert bullet points to HTML list items
                    .join('');

                Swal.fire({
                    title: `"${topic}" (${subject}) সম্পর্কে বিস্তারিত`,
                    html: `<ul class="list-disc list-inside text-left">${formattedHtml}</ul>`, // Display as HTML list
                    icon: 'info',
                    confirmButtonText: 'ঠিক আছে'
                });
            } catch (error) {
                console.error("Error fetching topic details from Gemini:", error);
                Swal.fire({
                     icon: 'error',
                     title: 'ত্রুটি!',
                     text: `টপিকের বিস্তারিত আনা সম্ভব হয়নি। ${error.message}`, // Show specific error message if available
                     confirmButtonText: 'ঠিক আছে'
                 });
            }
        }
        // --- *** END Gemini Topic Details Function *** ---


        // --- EVENT LISTENERS ---
        loginButton.addEventListener('click', handleLogin);
        googleLoginButton.addEventListener('click', handleGoogleLogin);
        forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); handlePasswordReset(); });
        [navDashboard, mobileNavDashboard].forEach(el => el.addEventListener('click', (e) => { e.preventDefault(); showView('dashboard'); }));
        [navProfile, mobileNavProfile].forEach(el => el.addEventListener('click', (e) => { e.preventDefault(); showView('profile'); }));
        [navAbout, mobileNavAbout].forEach(el => el.addEventListener('click', (e) => { e.preventDefault(); showView('about'); }));
        [navItems.logoutBtn, mobileLogoutBtn].forEach(el => el.addEventListener('click', handleLogout));

        startBtn.addEventListener('click', startTimer);
        stopBtn.addEventListener('click', () => stopTimer(true));
        getTopicDetailsBtn.addEventListener('click', getTopicDetails); // *** NEW: Listener for Gemini Button ***

        dailyGoalInput.addEventListener('change', async () => {
             if(state && userDocRef) { const newGoal = parseFloat(dailyGoalInput.value) || 7; try { await updateDoc(userDocRef, { dailyGoal: newGoal }); updateDashboardUIOnly(); } catch (e) { console.error("Error updating goal:", e); } }
        });

        saveProfileBtn.addEventListener('click', async () => {
             if(state && userDocRef) { const updatedProfile = { ...(state.profile || {}), name: profileNameInput.value.trim(), mobile: profileMobileInput.value.trim(), class: profileClassInput.value.trim(), institution: profileInstitutionInput.value.trim(), motivation: profileMotivationInput.value.trim() }; try { await updateDoc(userDocRef, { profile: updatedProfile }); Swal.fire({ icon: 'success', title: 'সফল!', text: 'প্রোফাইল তথ্য সংরক্ষণ করা হয়েছে।', timer: 1500 }); } catch (e) { Swal.fire({ icon: 'error', title: 'সমস্যা', text: 'প্রোফাইল সেভ করা যায়নি।' }); } }
        });

        profileImgUpload.addEventListener('change', async (e) => {
             const file = e.target.files[0]; if (!file || !currentUser || !userDocRef) return; if (file.size > 2 * 1048576) { Swal.fire({ icon: 'error', title: 'ছবি খুব বড়', text: '2MB-এর ছোট ছবি দিন।' }); e.target.value = null; return; } imgUploadSpinner.classList.remove('hidden'); const uniqueFileName = `${Date.now()}_${file.name}`; const storageRef = ref(storage, `profileImages/${currentUser.uid}/${uniqueFileName}`); try { const snapshot = await uploadBytes(storageRef, file); const downloadURL = await getDownloadURL(snapshot.ref); await updateDoc(userDocRef, { "profile.profileImg": downloadURL }); Swal.fire({ icon: 'success', title: 'সফল!', text: 'প্রোফাইল ছবি আপলোড হয়েছে।', timer: 1500 }); } catch (error) { Swal.fire({ icon: 'error', title: 'সমস্যা', text: 'ছবি আপলোড করা যায়নি।' }); } finally { imgUploadSpinner.classList.add('hidden'); e.target.value = null; }
        });

    }); // End of DOMContentLoaded
</script>

</body>
</html>
